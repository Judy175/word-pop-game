<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å•è¯æ¶ˆæ¶ˆä¹ï¼ˆç¦»çº¿ï¼‰</title>
  <style>
    :root{
      --bg: #fff5bf;
      --panel: rgba(255,255,255,.65);
      --shadow2: rgba(0,0,0,.10);
      --text: #1f2937;
      --dark: #111827;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      background: radial-gradient(circle at 20% 10%, rgba(255,255,255,.7), transparent 45%),
                  radial-gradient(circle at 85% 25%, rgba(255,255,255,.55), transparent 40%),
                  radial-gradient(circle at 30% 85%, rgba(255,255,255,.6), transparent 45%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 22px 16px 28px;
    }

    h1{
      margin: 6px 0 10px;
      font-size: clamp(34px, 4vw, 52px);
      letter-spacing: 2px;
      font-weight: 900;
      text-shadow: 0 2px 0 rgba(255,255,255,.7);
    }

    .topbar{
      width:min(1200px, 100%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 12px;
      padding: 10px 12px;
      background: var(--panel);
      border-radius: 16px;
      box-shadow: 0 10px 24px var(--shadow2);
      backdrop-filter: blur(6px);
      flex-wrap: wrap;
    }

    .status{
      display:flex;
      flex-wrap:wrap;
      gap:10px 10px;
      align-items:center;
      font-weight: 900;
      font-size: 16px;
    }
    .pill{
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.06);
      white-space: nowrap;
    }

    .btnrow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .btn{
      cursor:pointer;
      border:none;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 900;
      font-size: 15px;
      background: var(--dark);
      color:#fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      transition: transform .08s ease, filter .08s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.secondary{
      background: rgba(255,255,255,.85);
      color: var(--dark);
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.warn{
      background: #b91c1c;
    }

    .board-wrap{
      width:min(1200px, 100%);
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 22px;
      padding: 16px 16px 18px;
      box-shadow: 0 16px 30px rgba(0,0,0,.12);
      backdrop-filter: blur(6px);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      padding: 10px;
      align-items: stretch;
    }

    .bubble{
      position:relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 10px;
      cursor:pointer;
      user-select:none;
      box-shadow:
        0 18px 26px rgba(0,0,0,.18),
        0 6px 0 rgba(0,0,0,.10),
        inset 0 10px 18px rgba(255,255,255,.45),
        inset 0 -10px 18px rgba(0,0,0,.10);
      border: 2px solid rgba(255,255,255,.45);
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, outline .12s ease;
      overflow:hidden;
    }

    .bubble::before{
      content:"";
      position:absolute;
      inset: 10% 10% auto auto;
      width: 36%;
      height: 36%;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.2) 55%, transparent 70%);
      opacity: .9;
      pointer-events:none;
    }

    .bubble::after{
      content:"";
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.35), transparent 55%);
      pointer-events:none;
      mix-blend-mode: screen;
    }

    .bubble:hover{
      transform: translateY(-2px);
      filter: brightness(1.03);
    }

    .bubble.selected{
      outline: 6px solid rgba(17,24,39,.18);
      box-shadow:
        0 22px 34px rgba(0,0,0,.22),
        0 8px 0 rgba(0,0,0,.12),
        inset 0 10px 18px rgba(255,255,255,.50),
        inset 0 -10px 18px rgba(0,0,0,.10);
      transform: translateY(-3px) scale(1.02);
    }

    .bubble.hint{
      outline: 6px solid rgba(16,185,129,.25);
      transform: translateY(-3px) scale(1.03);
      filter: brightness(1.06);
    }

    .bubble.matched{
      visibility:hidden;
      pointer-events:none;
    }

    .bubble span{
      position:relative;
      z-index:1;
      font-weight: 900;
      font-size: clamp(18px, 1.8vw, 26px);
      line-height: 1.12;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      color: rgba(0,0,0,.80);
      word-break: break-word;
    }

    .overlay{
      margin-top: 12px;
      padding: 14px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 24px rgba(0,0,0,.10);
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .msg{
      font-size: 17px;
      font-weight: 900;
    }
    .hintText{
      font-size: 14px;
      opacity: .85;
      font-weight: 700;
      margin-top: 4px;
    }

    .result{
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      display:none;
    }
    .result.show{ display:block; }
    .stars{
      font-size: 26px;
      letter-spacing: 2px;
      margin: 6px 0 8px;
    }
    .resultLine{
      font-weight: 900;
      margin: 4px 0;
    }

    @media (max-width: 820px){
      .grid{ grid-template-columns: repeat(3, 1fr); }
      /* æ‰‹æœºä¸Šè‡ªåŠ¨3åˆ—æ›´å¥½ç‚¹ï¼›è‹¥ä½ åšæŒæ‰‹æœºä¹Ÿå¿…é¡»6åˆ—ï¼Œåˆ æ‰è¿™æ®µåª’ä½“æŸ¥è¯¢ */
    }
  </style>
</head>

<body>
  <h1>å•è¯æ¶ˆæ¶ˆä¹</h1>

  <div class="topbar">
    <div class="status">
      <div class="pill" id="levelPill">ç­‰çº§ï¼š1ï¼ˆCambridge 1ï¼‰</div>
      <div class="pill" id="themePill">ä¸»é¢˜ï¼šFood é£Ÿç‰©</div>
      <div class="pill" id="roundPill">å…³å¡ï¼š1</div>
      <div class="pill" id="timePill">ç”¨æ—¶ï¼š0.0s</div>
      <div class="pill" id="leftPill">å‰©ä½™æ³¡æ³¡ï¼š18</div>
      <div class="pill" id="scorePill">å¾—åˆ†ï¼š0</div>
      <div class="pill" id="comboPill">è¿å‡»ï¼š0</div>
      <div class="pill" id="errorPill">é”™è¯¯ï¼š0</div>
      <div class="pill" id="hintPill">æç¤ºï¼š0</div>
    </div>

    <div class="btnrow">
      <button class="btn secondary" id="speakToggleBtn" title="æœ‰äº›æµè§ˆå™¨éœ€è¦å…ˆç‚¹å‡»é¡µé¢æ‰èƒ½æœ—è¯»">æœ—è¯»ï¼šå¼€</button>
      <button class="btn warn" id="hintBtn" title="å…ˆé€‰ä¸­ä¸€ä¸ªæ³¡æ³¡å†ç‚¹æç¤ºï¼ˆæ‰£åˆ†å¹¶æ¸…ç©ºè¿å‡»ï¼‰">æç¤ºï¼ˆ-30åˆ†ï¼‰</button>
      <button class="btn secondary" id="restartBtn">é‡æ–°å¼€å§‹</button>
      <button class="btn" id="nextBtn" disabled>ç»§ç»­æŒ‘æˆ˜</button>
    </div>
  </div>

  <div class="board-wrap">
    <div class="grid" id="grid"></div>

    <div class="overlay">
      <div>
        <div class="msg" id="msg">ç‚¹å‡»ä¸€ä¸ªæ³¡æ³¡ä¼šæœ—è¯»ï¼›è¿ç»­ç‚¹å‡»ä¸¤ä¸ªæ³¡æ³¡å°è¯•é…å¯¹ã€‚</div>
        <div class="hintText">è§„åˆ™ï¼šè‹±æ–‡ â†” ä¸­æ–‡å«ä¹‰ä¸€è‡´å³é…å¯¹æˆåŠŸï¼›è¿å‡»è¶Šé«˜ï¼Œå¾—åˆ†è¶Šå¤šã€‚</div>
      </div>
    </div>

    <div class="result" id="resultBox">
      <div class="msg">ğŸ‰ æ­å–œä½ æŒ‘æˆ˜æˆåŠŸï¼</div>
      <div class="stars" id="starsLine">â­â­â­</div>
      <div class="resultLine" id="resultStats1"></div>
      <div class="resultLine" id="resultStats2"></div>
      <div class="resultLine" id="resultStats3"></div>
    </div>
  </div>

  <script>
    /***********************
     * ä¸»é¢˜å®šä¹‰ï¼ˆä¼šè½®æ¢ï¼‰
     ***********************/
    const THEMES = [
      { id:"food",   zh:"é£Ÿç‰©",     en:"Food" },
      { id:"animals",zh:"åŠ¨ç‰©",     en:"Animals" },
      { id:"school", zh:"å­¦æ ¡",     en:"School" },
      { id:"home",   zh:"å®¶åº­/å®¶",  en:"Home" },
      { id:"weather",zh:"å¤©æ°”",     en:"Weather" },
      { id:"places", zh:"åœ°ç‚¹",     en:"Places" },
      { id:"actions",zh:"åŠ¨ä½œ",     en:"Actions" },
      { id:"feelings",zh:"æ„Ÿå—",    en:"Feelings" },
      { id:"travel", zh:"æ—…è¡Œ",     en:"Travel" },
    ];

    /***********************
     * è¯åº“ï¼šCambridge å°‘å„¿è‹±è¯­ 1-3 çº§ï¼ˆæŒ‰ä¸»é¢˜åˆ†ç±»ï¼‰
     * æ¯æ¡æ˜¯ä¸€ä¸ªâ€œæ¦‚å¿µâ€ï¼Œæ¯å…³æŠ½9ä¸ªæ¦‚å¿µ -> 18æ³¡æ³¡ï¼ˆè‹±æ–‡+ä¸­æ–‡ï¼‰
     ***********************/
    const WORD_BANK = [
      // Level 1
      { level:1, theme:"food",    en:"apple", zh:"è‹¹æœ" },
      { level:1, theme:"food",    en:"banana", zh:"é¦™è•‰" },
      { level:1, theme:"food",    en:"milk", zh:"ç‰›å¥¶" },
      { level:1, theme:"food",    en:"bread", zh:"é¢åŒ…" },
      { level:1, theme:"food",    en:"egg", zh:"é¸¡è›‹" },
      { level:1, theme:"food",    en:"cake", zh:"è›‹ç³•" },
      { level:1, theme:"food",    en:"water", zh:"æ°´" },
      { level:1, theme:"food",    en:"rice", zh:"ç±³é¥­" },

      { level:1, theme:"animals", en:"cat", zh:"çŒ«" },
      { level:1, theme:"animals", en:"dog", zh:"ç‹—" },
      { level:1, theme:"animals", en:"fish", zh:"é±¼" },
      { level:1, theme:"animals", en:"bird", zh:"é¸Ÿ" },

      { level:1, theme:"school",  en:"book", zh:"ä¹¦" },
      { level:1, theme:"school",  en:"pen", zh:"é’¢ç¬”" },
      { level:1, theme:"school",  en:"pencil", zh:"é“…ç¬”" },

      { level:1, theme:"home",    en:"chair", zh:"æ¤…å­" },
      { level:1, theme:"home",    en:"table", zh:"æ¡Œå­" },
      { level:1, theme:"home",    en:"door", zh:"é—¨" },
      { level:1, theme:"home",    en:"window", zh:"çª—æˆ·" },

      { level:1, theme:"places",  en:"park", zh:"å…¬å›­" },
      { level:1, theme:"places",  en:"shop", zh:"å•†åº—" },

      { level:1, theme:"actions", en:"run", zh:"è·‘" },
      { level:1, theme:"actions", en:"jump", zh:"è·³" },
      { level:1, theme:"actions", en:"read", zh:"è¯»" },
      { level:1, theme:"actions", en:"write", zh:"å†™" },

      { level:1, theme:"feelings", en:"happy", zh:"å¼€å¿ƒ" },
      { level:1, theme:"feelings", en:"sad", zh:"éš¾è¿‡" },

      { level:1, theme:"weather", en:"sunny", zh:"æ™´æœ—çš„" },
      { level:1, theme:"weather", en:"rainy", zh:"ä¸‹é›¨çš„" },

      // Level 2
      { level:2, theme:"food", en:"breakfast", zh:"æ—©é¤" },
      { level:2, theme:"food", en:"lunch", zh:"åˆé¤" },
      { level:2, theme:"food", en:"dinner", zh:"æ™šé¤" },
      { level:2, theme:"food", en:"juice", zh:"æœæ±" },
      { level:2, theme:"food", en:"sandwich", zh:"ä¸‰æ˜æ²»" },

      { level:2, theme:"home", en:"kitchen", zh:"å¨æˆ¿" },
      { level:2, theme:"home", en:"bathroom", zh:"æµ´å®¤" },
      { level:2, theme:"home", en:"bedroom", zh:"å§å®¤" },
      { level:2, theme:"home", en:"garden", zh:"èŠ±å›­" },

      { level:2, theme:"school", en:"teacher", zh:"è€å¸ˆ" },
      { level:2, theme:"school", en:"student", zh:"å­¦ç”Ÿ" },
      { level:2, theme:"school", en:"homework", zh:"ä½œä¸š" },
      { level:2, theme:"school", en:"picture", zh:"å›¾ç‰‡" },

      { level:2, theme:"places", en:"library", zh:"å›¾ä¹¦é¦†" },
      { level:2, theme:"places", en:"hospital", zh:"åŒ»é™¢" },
      { level:2, theme:"places", en:"station", zh:"è½¦ç«™" },
      { level:2, theme:"places", en:"supermarket", zh:"è¶…å¸‚" },

      { level:2, theme:"actions", en:"swimming", zh:"æ¸¸æ³³" },
      { level:2, theme:"actions", en:"drawing", zh:"ç”»ç”»" },
      { level:2, theme:"actions", en:"reading", zh:"é˜…è¯»" },
      { level:2, theme:"actions", en:"listening", zh:"å¬" },

      { level:2, theme:"weather", en:"cloudy", zh:"å¤šäº‘" },
      { level:2, theme:"weather", en:"windy", zh:"æœ‰é£çš„" },
      { level:2, theme:"weather", en:"snowy", zh:"ä¸‹é›ªçš„" },

      { level:2, theme:"animals", en:"rabbit", zh:"å…”å­" },
      { level:2, theme:"animals", en:"horse", zh:"é©¬" },
      { level:2, theme:"animals", en:"duck", zh:"é¸­å­" },

      { level:2, theme:"feelings", en:"hungry", zh:"é¥¿çš„" },
      { level:2, theme:"feelings", en:"tired", zh:"ç´¯çš„" },

      // Level 3
      { level:3, theme:"travel", en:"travelling", zh:"æ—…è¡Œ" },
      { level:3, theme:"travel", en:"holiday", zh:"å‡æœŸ" },
      { level:3, theme:"travel", en:"ticket", zh:"ç¥¨" },
      { level:3, theme:"travel", en:"direction", zh:"æ–¹å‘" },

      { level:3, theme:"places", en:"museum", zh:"åšç‰©é¦†" },
      { level:3, theme:"places", en:"restaurant", zh:"é¤å…" },
      { level:3, theme:"places", en:"bridge", zh:"æ¡¥" },

      { level:3, theme:"animals", en:"dolphin", zh:"æµ·è±š" },
      { level:3, theme:"animals", en:"tiger", zh:"è€è™" },

      { level:3, theme:"weather", en:"stormy", zh:"æš´é£é›¨çš„" },

      { level:3, theme:"actions", en:"remember", zh:"è®°å¾—" },
      { level:3, theme:"actions", en:"forget", zh:"å¿˜è®°" },
      { level:3, theme:"actions", en:"invite", zh:"é‚€è¯·" },
      { level:3, theme:"actions", en:"decide", zh:"å†³å®š" },
      { level:3, theme:"actions", en:"practice", zh:"ç»ƒä¹ " },

      { level:3, theme:"feelings", en:"excited", zh:"å…´å¥‹çš„" },
      { level:3, theme:"feelings", en:"surprised", zh:"æƒŠè®¶çš„" },

      { level:3, theme:"school", en:"question", zh:"é—®é¢˜" },
      { level:3, theme:"school", en:"answer", zh:"å›ç­”" },

      { level:3, theme:"food", en:"delicious", zh:"ç¾å‘³çš„" },
      { level:3, theme:"food", en:"customer", zh:"é¡¾å®¢" },

      { level:3, theme:"travel", en:"adventure", zh:"å†’é™©" },
      { level:3, theme:"travel", en:"island", zh:"å²›" },
      { level:3, theme:"travel", en:"mountain", zh:"å±±" },
      { level:3, theme:"travel", en:"forest", zh:"æ£®æ—" },
      { level:3, theme:"travel", en:"river", zh:"æ²³æµ" },

      { level:3, theme:"feelings", en:"important", zh:"é‡è¦çš„" },
      { level:3, theme:"feelings", en:"different", zh:"ä¸åŒçš„" },
      { level:3, theme:"feelings", en:"dangerous", zh:"å±é™©çš„" },
      { level:3, theme:"feelings", en:"careful", zh:"å°å¿ƒçš„" },
    ];

    /***********************
     * æ¸¸æˆé…ç½®
     ***********************/
    const PAIRS_PER_ROUND = 9; // 9å¯¹ => 18æ³¡æ³¡ï¼ˆ6x3ï¼‰
    const ROWS = 3;
    const COLS = 6;

    // çŠ¶æ€
    let currentLevel = 1;
    let round = 1;
    let themeIndex = 0;

    // ç”¨äºâ€œä¸ä¸Šä¸€å…³ä¸é‡å¤â€ï¼šæŒ‰ç­‰çº§åˆ†åˆ«è®°å½•ï¼ˆæ›´è´´åˆå­©å­å­¦ä¹ ï¼‰
    let usedKeysByLevel = {
      1: new Set(),
      2: new Set(),
      3: new Set(),
    };

    let items = [];
    let bubbles = [];
    let firstPick = null;
    let lock = false;

    // è®¡æ—¶
    let t0 = 0;
    let timer = null;
    let elapsed = 0;

    // æœ—è¯»
    let speakEnabled = true;

    // è®¡åˆ†/ç»Ÿè®¡
    let score = 0;
    let combo = 0;
    let errors = 0;
    let hintsUsed = 0;
    let roundCleared = false;

    // DOM
    const gridEl = document.getElementById("grid");
    const msgEl = document.getElementById("msg");
    const levelPill = document.getElementById("levelPill");
    const themePill = document.getElementById("themePill");
    const roundPill = document.getElementById("roundPill");
    const timePill = document.getElementById("timePill");
    const leftPill = document.getElementById("leftPill");
    const scorePill = document.getElementById("scorePill");
    const comboPill = document.getElementById("comboPill");
    const errorPill = document.getElementById("errorPill");
    const hintPill = document.getElementById("hintPill");

    const nextBtn = document.getElementById("nextBtn");
    const restartBtn = document.getElementById("restartBtn");
    const speakToggleBtn = document.getElementById("speakToggleBtn");
    const hintBtn = document.getElementById("hintBtn");

    const resultBox = document.getElementById("resultBox");
    const starsLine = document.getElementById("starsLine");
    const resultStats1 = document.getElementById("resultStats1");
    const resultStats2 = document.getElementById("resultStats2");
    const resultStats3 = document.getElementById("resultStats3");

    /***********************
     * å·¥å…·ï¼šéšæœº & æ´—ç‰Œ
     ***********************/
    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /***********************
     * æ³¡æ³¡é¢œè‰²
     ***********************/
    function randomBubbleGradient(){
      const h = randInt(0, 359);
      const s = randInt(72, 92);
      const l1 = randInt(54, 68);
      const l2 = l1 - randInt(10, 16);
      return `radial-gradient(circle at 30% 25%,
        hsla(${h}, ${s}%, ${l1+18}%, 0.95),
        hsla(${h}, ${s}%, ${l1}%, 0.95) 45%,
        hsla(${h}, ${s}%, ${l2}%, 0.95) 78%,
        hsla(${h}, ${s}%, ${l2-8}%, 0.95)
      )`;
    }

    /***********************
     * å£°éŸ³ï¼šWebAudioï¼ˆç¦»çº¿ï¼‰
     ***********************/
    let audioCtx = null;
    function getAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioCtx;
    }
    function playTone({type="sine", freq=880, dur=0.12, gain=0.08}){
      const ctx = getAudio();
      const t = ctx.currentTime;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();

      osc.type = type;
      osc.frequency.setValueAtTime(freq, t);

      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

      osc.connect(g);
      g.connect(ctx.destination);

      osc.start(t);
      osc.stop(t + dur + 0.02);
    }
    function soundSuccess(){
      playTone({type:"triangle", freq: 880, dur: 0.10, gain: 0.08});
      setTimeout(()=> playTone({type:"triangle", freq: 1320, dur: 0.12, gain: 0.08}), 90);
    }
    function soundFail(){
      playTone({type:"sawtooth", freq: 220, dur: 0.18, gain: 0.06});
      setTimeout(()=> playTone({type:"sawtooth", freq: 170, dur: 0.18, gain: 0.05}), 80);
    }
    function soundHint(){
      playTone({type:"sine", freq: 660, dur: 0.08, gain: 0.05});
      setTimeout(()=> playTone({type:"sine", freq: 880, dur: 0.10, gain: 0.05}), 70);
    }

    /***********************
     * æœ—è¯»ï¼šSpeechSynthesisï¼ˆç¦»çº¿å¯ç”¨ï¼‰
     ***********************/
    function speak(text){
      if(!speakEnabled) return;
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const isZh = /[\u4e00-\u9fff]/.test(text);
      u.lang = isZh ? "zh-CN" : "en-US";
      u.rate = isZh ? 0.95 : 0.92;
      u.pitch = 1.05;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }

    /***********************
     * ä¸»é¢˜ & ç­‰çº§
     ***********************/
    function levelLabel(lv){
      if(lv === 1) return "ç­‰çº§ï¼š1ï¼ˆCambridge 1ï¼‰";
      if(lv === 2) return "ç­‰çº§ï¼š2ï¼ˆCambridge 2ï¼‰";
      return "ç­‰çº§ï¼š3ï¼ˆCambridge 3ï¼‰";
    }
    function currentTheme(){
      return THEMES[themeIndex % THEMES.length];
    }

    function makeKey(w){
      return `${w.level}::${w.theme}::${w.en.toLowerCase()}`;
    }

    function getPool(level, themeId){
      return WORD_BANK
        .filter(w => w.level === level && w.theme === themeId)
        .map(w => ({...w, key: makeKey(w)}));
    }

    function pickConceptsForRound(){
      const th = currentTheme();
      let pool = getPool(currentLevel, th.id);
      let used = usedKeysByLevel[currentLevel];
      let remaining = pool.filter(x => !used.has(x.key));

      // å¦‚æœè¯¥ä¸»é¢˜åœ¨è¯¥ç­‰çº§è¯ä¸å¤Ÿ/ç”¨å®Œï¼šè‡ªåŠ¨æ¢ä¸‹ä¸€ä¸ªä¸»é¢˜
      let guard = 0;
      while(remaining.length < PAIRS_PER_ROUND && guard < THEMES.length){
        themeIndex += 1;
        guard += 1;
        const th2 = currentTheme();
        pool = getPool(currentLevel, th2.id);
        remaining = pool.filter(x => !used.has(x.key));
      }

      // å¦‚æœæ•´ä¸ªç­‰çº§éƒ½ä¸å¤Ÿï¼ˆæ¯”å¦‚ä¸»é¢˜éƒ½è¯•å®Œè¿˜ä¸å¤Ÿï¼‰ï¼šå‡çº§ç­‰çº§/æˆ–å¾ªç¯é‡ç½®
      if(remaining.length < PAIRS_PER_ROUND){
        if(currentLevel < 3){
          currentLevel += 1;
          themeIndex += 1; // å‡çº§åä¹Ÿæ¢ä¸ªä¸»é¢˜
          // æ–°ç­‰çº§å¼€å§‹å‰æ¸…ç©ºå…¶ usedï¼ˆå¯é‡å¤ç©ï¼Œä½†åŒç­‰çº§å†…å°½é‡ä¸é‡å¤ï¼‰
          usedKeysByLevel[currentLevel] = usedKeysByLevel[currentLevel] || new Set();
          used = usedKeysByLevel[currentLevel];

          pool = getPool(currentLevel, currentTheme().id);
          remaining = pool.filter(x => !used.has(x.key));

          // ä»ä¸å¤Ÿåˆ™ç»§ç»­æ¢ä¸»é¢˜
          let g2 = 0;
          while(remaining.length < PAIRS_PER_ROUND && g2 < THEMES.length){
            themeIndex += 1;
            g2 += 1;
            pool = getPool(currentLevel, currentTheme().id);
            remaining = pool.filter(x => !used.has(x.key));
          }
        } else {
          // å…¨éƒ¨ç­‰çº§éƒ½ç©äº†ä¸€è½®ï¼šä»å¤´å¾ªç¯
          currentLevel = 1;
          round = 1;
          themeIndex = 0;
          usedKeysByLevel = { 1:new Set(), 2:new Set(), 3:new Set() };

          pool = getPool(currentLevel, currentTheme().id);
          remaining = pool;
        }
      }

      shuffle(remaining);
      const chosen = remaining.slice(0, PAIRS_PER_ROUND);
      chosen.forEach(c => usedKeysByLevel[currentLevel].add(c.key));
      return chosen;
    }

    /***********************
     * è®¡æ—¶
     ***********************/
    function resetTimer(){
      if(timer) clearInterval(timer);
      elapsed = 0;
      timePill.textContent = `ç”¨æ—¶ï¼š0.0s`;
      t0 = performance.now();
      timer = setInterval(()=>{
        elapsed = (performance.now() - t0) / 1000;
        timePill.textContent = `ç”¨æ—¶ï¼š${elapsed.toFixed(1)}s`;
      }, 100);
    }

    /***********************
     * è®¡åˆ†è§„åˆ™ï¼ˆå¯è‡ªè¡Œæ”¹ï¼‰
     * - æˆåŠŸï¼šåŸºç¡€ 50 åˆ† + è¿å‡»åŠ æˆï¼ˆæ¯è¿å‡» +10ï¼‰
     * - å¤±è´¥ï¼š-10 åˆ†ï¼ˆæœ€ä½ä¸ä½äº0ï¼‰ï¼Œè¿å‡»æ¸…é›¶
     * - æç¤ºï¼š-30 åˆ†ï¼ˆæœ€ä½ä¸ä½äº0ï¼‰ï¼Œè¿å‡»æ¸…é›¶
     ***********************/
    function addScore(n){
      score = Math.max(0, score + n);
      scorePill.textContent = `å¾—åˆ†ï¼š${score}`;
    }
    function setCombo(n){
      combo = n;
      comboPill.textContent = `è¿å‡»ï¼š${combo}`;
    }
    function incErrors(){
      errors += 1;
      errorPill.textContent = `é”™è¯¯ï¼š${errors}`;
    }
    function incHints(){
      hintsUsed += 1;
      hintPill.textContent = `æç¤ºï¼š${hintsUsed}`;
    }

    /***********************
     * UI æ›´æ–°
     ***********************/
    function updateTop(){
      const th = currentTheme();
      levelPill.textContent = levelLabel(currentLevel);
      themePill.textContent = `ä¸»é¢˜ï¼š${th.en} ${th.zh}`;
      roundPill.textContent = `å…³å¡ï¼š${round}`;
      const left = bubbles.filter(b => !b.matched).length;
      leftPill.textContent = `å‰©ä½™æ³¡æ³¡ï¼š${left}`;
      scorePill.textContent = `å¾—åˆ†ï¼š${score}`;
      comboPill.textContent = `è¿å‡»ï¼š${combo}`;
      errorPill.textContent = `é”™è¯¯ï¼š${errors}`;
      hintPill.textContent = `æç¤ºï¼š${hintsUsed}`;
    }

    function showResult(){
      // è¯„æ˜Ÿï¼šç»¼åˆç”¨æ—¶/é”™è¯¯/æç¤º
      // ä½ ä¹Ÿå¯ä»¥æŒ‰å­©å­å¹´é¾„è°ƒæ•´é˜ˆå€¼
      let stars = 3;

      if(hintsUsed > 0) stars -= 1;
      if(errors >= 4) stars -= 1;
      if(elapsed > 80) stars -= 1;

      stars = Math.max(0, Math.min(3, stars));
      starsLine.textContent = "â­".repeat(stars) + "â˜†".repeat(3 - stars);

      resultStats1.textContent = `ç”¨æ—¶ï¼š${elapsed.toFixed(1)} ç§’   |   å¾—åˆ†ï¼š${score}`;
      resultStats2.textContent = `é”™è¯¯æ¬¡æ•°ï¼š${errors}   |   æç¤ºæ¬¡æ•°ï¼š${hintsUsed}`;
      resultStats3.textContent = `ç­‰çº§ï¼š${currentLevel}   |   ä¸»é¢˜ï¼š${currentTheme().en} ${currentTheme().zh}`;

      resultBox.classList.add("show");
    }

    function hideResult(){
      resultBox.classList.remove("show");
    }

    /***********************
     * æ¸²æŸ“ & äº¤äº’
     ***********************/
    function buildRound(){
      firstPick = null;
      lock = false;
      roundCleared = false;

      nextBtn.disabled = true;
      msgEl.textContent = "ç‚¹å‡»ä¸€ä¸ªæ³¡æ³¡ä¼šæœ—è¯»ï¼›è¿ç»­ç‚¹å‡»ä¸¤ä¸ªæ³¡æ³¡å°è¯•é…å¯¹ã€‚";
      hideResult();

      // æœ¬å…³ç»Ÿè®¡é‡ç½®ï¼ˆä¹Ÿå¯ä»¥æ”¹æˆè·¨å…³ç´¯è®¡ï¼‰
      score = 0;
      combo = 0;
      errors = 0;
      hintsUsed = 0;

      items = pickConceptsForRound();

      // ç”Ÿæˆ 18 ä¸ªæ³¡æ³¡ï¼šæ¯ä¸ªæ¦‚å¿µè‹±æ–‡+ä¸­æ–‡å„ä¸€ä¸ª
      bubbles = [];
      items.forEach((c, idx)=>{
        const id = `${currentLevel}-${round}-${idx}-${c.en}`;
        bubbles.push({ id, pairKey: id, text: c.en, lang: "en", matched:false, color: randomBubbleGradient() });
        bubbles.push({ id, pairKey: id, text: c.zh, lang: "zh", matched:false, color: randomBubbleGradient() });
      });

      shuffle(bubbles);

      // æ¸²æŸ“
      gridEl.innerHTML = "";
      bubbles.forEach((b, i)=>{
        const div = document.createElement("div");
        div.className = "bubble";
        div.style.background = b.color;
        div.dataset.index = String(i);

        const span = document.createElement("span");
        span.textContent = b.text;
        div.appendChild(span);

        div.addEventListener("click", onBubbleClick);
        gridEl.appendChild(div);
      });

      updateTop();
      resetTimer();
    }

    function clearSelectionUI(){
      const els = gridEl.querySelectorAll(".bubble.selected");
      els.forEach(el => el.classList.remove("selected"));
    }
    function clearHintUI(){
      const els = gridEl.querySelectorAll(".bubble.hint");
      els.forEach(el => el.classList.remove("hint"));
    }

    function markMatched(indexA, indexB){
      bubbles[indexA].matched = true;
      bubbles[indexB].matched = true;

      const elA = gridEl.querySelector(`.bubble[data-index="${indexA}"]`);
      const elB = gridEl.querySelector(`.bubble[data-index="${indexB}"]`);
      if(elA) elA.classList.add("matched");
      if(elB) elB.classList.add("matched");
    }

    function checkWin(){
      const left = bubbles.filter(b => !b.matched).length;
      updateTop();
      if(left === 0){
        if(timer) clearInterval(timer);
        roundCleared = true;
        msgEl.textContent = `ğŸ‰ æ­å–œä½ æŒ‘æˆ˜æˆåŠŸï¼ç”¨æ—¶ ${elapsed.toFixed(1)} ç§’ã€‚`;
        nextBtn.disabled = false;
        showResult();
      }
    }

    function onBubbleClick(e){
      if(lock || roundCleared) return;

      clearHintUI();

      const el = e.currentTarget;
      const idx = Number(el.dataset.index);
      const b = bubbles[idx];
      if(b.matched) return;

      // é«˜äº® + æœ—è¯»
      clearSelectionUI();
      el.classList.add("selected");
      speak(b.text);

      // é€‰ç¬¬ä¸€ä¸ª
      if(!firstPick){
        firstPick = { idx, pairKey: b.pairKey };
        return;
      }

      // ç‚¹åŒä¸€ä¸ªï¼šå½“ä½œä»é€‰ç¬¬ä¸€ä¸ª
      if(firstPick.idx === idx){
        return;
      }

      const secondPick = { idx, pairKey: b.pairKey };

      // åŒ¹é…æˆåŠŸ
      if(firstPick.pairKey === secondPick.pairKey){
        soundSuccess();

        // è®¡åˆ†ï¼šåŸºç¡€50 + è¿å‡»åŠ æˆ
        const gained = 50 + combo * 10;
        addScore(gained);
        setCombo(combo + 1);

        markMatched(firstPick.idx, secondPick.idx);
        firstPick = null;
        clearSelectionUI();
        checkWin();
      } else {
        // ä¸åŒ¹é…ï¼šæ³¡æ³¡ä¿æŒåŸçŠ¶
        soundFail();
        lock = true;

        incErrors();
        addScore(-10);
        setCombo(0);

        const el1 = gridEl.querySelector(`.bubble[data-index="${firstPick.idx}"]`);
        const el2 = gridEl.querySelector(`.bubble[data-index="${secondPick.idx}"]`);
        if(el1) el1.classList.add("selected");
        if(el2) el2.classList.add("selected");

        setTimeout(()=>{
          clearSelectionUI();
          firstPick = null;
          lock = false;
        }, 520);
      }
    }

    /***********************
     * æç¤ºï¼ˆéœ€è¦å…ˆé€‰ä¸­ä¸€ä¸ªæ³¡æ³¡ï¼‰
     * æ•ˆæœï¼šçŸ­æš‚é«˜äº®å®ƒçš„åŒ¹é…æ³¡æ³¡ï¼ˆä¸ç›´æ¥æ¶ˆé™¤ï¼‰
     * ä»£ä»·ï¼š-30åˆ† + æ¸…é›¶è¿å‡» + æç¤ºæ¬¡æ•°+1
     ***********************/
    function useHint(){
      if(lock || roundCleared) return;
      if(!firstPick) {
        msgEl.textContent = "å…ˆç‚¹é€‰ä¸€ä¸ªæ³¡æ³¡ï¼Œå†ç‚¹â€œæç¤ºâ€å“¦ï½";
        return;
      }

      // æ‰£åˆ† + ç»Ÿè®¡
      incHints();
      addScore(-30);
      setCombo(0);
      soundHint();

      const targetKey = firstPick.pairKey;
      const matchIndex = bubbles.findIndex((b, i) => !b.matched && i !== firstPick.idx && b.pairKey === targetKey);
      if(matchIndex === -1) return;

      const elA = gridEl.querySelector(`.bubble[data-index="${firstPick.idx}"]`);
      const elB = gridEl.querySelector(`.bubble[data-index="${matchIndex}"]`);

      clearHintUI();
      if(elA) elA.classList.add("hint");
      if(elB) elB.classList.add("hint");

      setTimeout(()=>{
        clearHintUI();
      }, 900);
    }

    /***********************
     * æŒ‰é’®
     ***********************/
    hintBtn.addEventListener("click", useHint);

    nextBtn.addEventListener("click", ()=>{
      round += 1;
      themeIndex += 1; // æ¯å…³æ¢ä¸»é¢˜
      buildRound();
    });

    restartBtn.addEventListener("click", ()=>{
      currentLevel = 1;
      round = 1;
      themeIndex = 0;
      usedKeysByLevel = { 1:new Set(), 2:new Set(), 3:new Set() };
      buildRound();
    });

    speakToggleBtn.addEventListener("click", ()=>{
      speakEnabled = !speakEnabled;
      speakToggleBtn.textContent = `æœ—è¯»ï¼š${speakEnabled ? "å¼€" : "å…³"}`;
      if(!speakEnabled && ("speechSynthesis" in window)){
        window.speechSynthesis.cancel();
      }
    });

    // è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆéƒ¨åˆ†æµè§ˆå™¨éœ€è¦å…ˆäº¤äº’ï¼‰
    document.addEventListener("pointerdown", ()=>{
      try{
        const ctx = getAudio();
        if(ctx.state === "suspended") ctx.resume();
      }catch(_){}
    }, { once:false });

    // å¯åŠ¨
    buildRound();
  </script>
</body>
</html>
